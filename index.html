<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tic Tac Toe Online 3D</title>
<style>
  body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f0f0f0; margin:0; overflow: hidden;}
  #game, #menu { display: none; flex-direction: column; align-items: center; }
  #menu { display:flex; }
  #board { display: grid; grid-template: repeat(3, 100px) / repeat(3, 100px); gap: 5px; margin: 20px; perspective: 1000px;}
  .cell { background: white; display: flex; justify-content: center; align-items: center; font-size: 2em; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transform-style: preserve-3d; transition: transform 0.5s;}
  .cell.played { transform: rotateY(180deg); }
  #popup { display: none; position: fixed; top:50%; left:50%; transform: translate(-50%, -50%); background: #fff; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: popupAppear 0.5s forwards;}
  #popup h2 { margin: 0 0 20px 0; }
  button { padding: 10px 20px; margin: 5px; border:none; border-radius: 10px; cursor:pointer; font-size:1em; background: #3498db; color: #fff; transition: transform 0.2s;}
  button:hover { transform: scale(1.1); }
  @keyframes popupAppear { from {transform: translate(-50%, -60%) scale(0);} to {transform: translate(-50%, -50%) scale(1);} }
  .win-line { position: absolute; height: 5px; background: red; transform-origin: left; animation: drawLine 0.5s forwards;}
  @keyframes drawLine { from {width:0;} to {width:100%;} }
  canvas { position: fixed; top:0; left:0; pointer-events:none; }
</style>
</head>
<body>

<div id="menu">
  <h1>Tic Tac Toe</h1>
  <button onclick="startGame('online')">Play Online</button>
  <button onclick="startGame('easy')">AI Easy</button>
  <button onclick="startGame('medium')">AI Medium</button>
  <button onclick="startGame('hard')">AI Hard</button>
</div>

<div id="game">
  <div id="board"></div>
  <button onclick="goHome()">Back to Menu</button>
</div>

<div id="popup">
  <h2 id="popupText"></h2>
  <button onclick="closePopup()">OK</button>
</div>

<canvas id="confetti"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

// Firebase config (replace with your own)
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let boardState = Array(9).fill('');
let player = 'X';
let onlineGameId = null;
let isMyTurn = true;
let aiMode = null;

const boardEl = document.getElementById('board');
const menuEl = document.getElementById('menu');
const gameEl = document.getElementById('game');
const popupEl = document.getElementById('popup');
const popupText = document.getElementById('popupText');
const confettiCanvas = document.getElementById('confetti');
const ctx = confettiCanvas.getContext('2d');
let confettiParticles = [];

// Resize canvas
function resizeCanvas(){confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight;}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Initialize board
function drawBoard() {
  boardEl.innerHTML = '';
  boardState.forEach((cell, idx) => {
    const div = document.createElement('div');
    div.classList.add('cell');
    if(cell!=='') div.classList.add('played');
    div.textContent = cell;
    div.onclick = () => handleMove(idx);
    boardEl.appendChild(div);
  });
}

// Handle move
function handleMove(idx) {
  if(boardState[idx] !== '' || (!isMyTurn && onlineGameId)) return;
  boardState[idx] = player;
  drawBoard();
  if(checkWin(player)) { showPopup(player + ' Wins!'); winEffect(); syncBoard(); return;}
  else if(boardState.every(c=>c!=='')) { showPopup('Draw!'); syncBoard(); return; }

  if(onlineGameId){ isMyTurn = false; syncBoard(); }
  else if(aiMode){ player = player==='X'?'O':'X'; aiMove(); player = player==='X'?'O':'X'; }
  else{ player = player==='X'?'O':'X'; }
}

// AI Move
function aiMove() {
  let empty = boardState.map((v,i)=>v===''?i:null).filter(v=>v!==null);
  let move;
  if(aiMode==='easy'){ move = empty[Math.floor(Math.random()*empty.length)]; }
  else if(aiMode==='medium'){ move = findWinningMove('O') || findWinningMove('X') || empty[Math.floor(Math.random()*empty.length)]; }
  else { move = findBestMove(boardState,'O'); }
  boardState[move]='O';
  drawBoard();
  if(checkWin('O')) { showPopup('O Wins!'); winEffect(); }
}

// Simple AI functions
function findWinningMove(p){
  for(let i=0;i<9;i++){
    if(boardState[i]===''){ boardState[i]=p; if(checkWin(p)){ boardState[i]=''; return i;} boardState[i]=''; }
  }
  return null;
}

// Minimax for Hard
function findBestMove(bd, ai){
  let bestScore=-Infinity; let move;
  for(let i=0;i<9;i++){
    if(bd[i]===''){ bd[i]=ai; let score=minimax(bd,false); bd[i]=''; if(score>bestScore){bestScore=score; move=i;} }
  }
  return move;
}
function minimax(bd,isMax){
  if(checkWin('O')) return 1;
  if(checkWin('X')) return -1;
  if(bd.every(c=>c!=='')) return 0;
  let scores=[];
  for(let i=0;i<9;i++){ if(bd[i]===''){ bd[i]=isMax?'O':'X'; scores.push(minimax(bd,!isMax)); bd[i]=''; } }
  return isMax?Math.max(...scores):Math.min(...scores);
}

// Check win
function checkWin(p){
  const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  return wins.some(line=>line.every(i=>boardState[i]===p));
}

// Popup
function showPopup(msg){popupText.textContent=msg; popupEl.style.display='block';}
function closePopup(){popupEl.style.display='none'; boardState=Array(9).fill(''); drawBoard(); isMyTurn=true; player='X';}

// Menu navigation
function startGame(mode){
  menuEl.style.display='none';
  gameEl.style.display='flex';
  boardState = Array(9).fill('');
  drawBoard();
  aiMode = (mode==='easy'||mode==='medium'||mode==='hard')?mode:null;
  if(mode==='online') initOnlineGame();
}
function goHome(){menuEl.style.display='flex'; gameEl.style.display='none'; popupEl.style.display='none'; confettiParticles=[];}

// Firebase Online
function initOnlineGame(){
  onlineGameId = 'game1'; // For testing only
  const gameRef = ref(db, 'ticTacToe/'+onlineGameId+'/board');
  onValue(gameRef, (snapshot)=>{
    const data = snapshot.val();
    if(data){
      boardState = data.board;
      isMyTurn = data.turn === player;
      drawBoard();
    }
  });
  syncBoard();
}
function syncBoard(){
  if(!onlineGameId) return;
  const gameRef = ref(db, 'ticTacToe/'+onlineGameId+'/board');
  set(gameRef, { board: boardState, turn: player==='X'?'O':'X' });
}

// Confetti effect
function winEffect(){
  for(let i=0;i<150;i++){
    confettiParticles.push({
      x: Math.random()*confettiCanvas.width,
      y: Math.random()*confettiCanvas.height-100,
      r: Math.random()*6+2,
      d: Math.random()*10+5,
      color: `hsl(${Math.random()*360},100%,50%)`,
      tilt: Math.random()*10-10,
      tiltAngleIncrement: Math.random()*0.07+0.05,
      tiltAngle:0
    });
  }
  requestAnimationFrame(drawConfetti);
}
function drawConfetti(){
  ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  confettiParticles.forEach((p,i)=>{
    p.tiltAngle += p.tiltAngleIncrement;
    p.y += (Math.cos(p.d)+3+p.r/2)/2;
    p.x += Math.sin(0.1);
    p.tilt = Math.sin(p.tiltAngle)*15;
    ctx.beginPath();
    ctx.lineWidth = p.r;
    ctx.strokeStyle = p.color;
    ctx.moveTo(p.x+p.tilt+ p.r/2, p.y);
    ctx.lineTo(p.x+p.tilt, p.y+p.tilt+ p.r/2);
    ctx.stroke();
  });
  confettiParticles = confettiParticles.filter(p=>p.y<confettiCanvas.height+20);
  if(confettiParticles.length>0) requestAnimationFrame(drawConfetti);
}

drawBoard();
menuEl.style.display='flex';
</script>

</body>
</html>
