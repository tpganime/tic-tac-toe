<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tic Tac Toe Online</title>
<style>
  body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f0f0f0; margin:0; }
  #game { display: none; flex-direction: column; align-items: center; }
  #board { display: grid; grid-template: repeat(3, 100px) / repeat(3, 100px); gap: 5px; margin: 20px; }
  .cell { background: white; display: flex; justify-content: center; align-items: center; font-size: 2em; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
  #popup { display: none; position: fixed; top:50%; left:50%; transform: translate(-50%, -50%); background: #fff; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
  #popup h2 { margin: 0 0 20px 0; }
  button { padding: 10px 20px; margin: 5px; border:none; border-radius: 10px; cursor:pointer; font-size:1em;}
</style>
</head>
<body>

<div id="menu">
  <h1>Tic Tac Toe</h1>
  <button onclick="startGame('online')">Play Online</button>
  <button onclick="startGame('easy')">AI Easy</button>
  <button onclick="startGame('medium')">AI Medium</button>
  <button onclick="startGame('hard')">AI Hard</button>
</div>

<div id="game">
  <div id="board"></div>
  <button onclick="goHome()">Back to Menu</button>
</div>

<div id="popup">
  <h2 id="popupText"></h2>
  <button onclick="closePopup()">OK</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

// Firebase config (replace with your own)
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let boardState = Array(9).fill('');
let player = 'X';
let onlineGameId = null;
let isMyTurn = true;
let aiMode = null;

const boardEl = document.getElementById('board');
const menuEl = document.getElementById('menu');
const gameEl = document.getElementById('game');
const popupEl = document.getElementById('popup');
const popupText = document.getElementById('popupText');

// Initialize board
function drawBoard() {
  boardEl.innerHTML = '';
  boardState.forEach((cell, idx) => {
    const div = document.createElement('div');
    div.classList.add('cell');
    div.textContent = cell;
    div.onclick = () => handleMove(idx);
    boardEl.appendChild(div);
  });
}

// Handle move
function handleMove(idx) {
  if(boardState[idx] !== '' || (!isMyTurn && onlineGameId)) return;

  boardState[idx] = player;
  drawBoard();

  if(checkWin(player)) {
    showPopup(player + ' Wins!');
    syncBoard();
    return;
  } else if(boardState.every(c=>c!=='')) {
    showPopup('Draw!');
    syncBoard();
    return;
  }

  if(onlineGameId) {
    isMyTurn = false;
    syncBoard();
  } else if(aiMode) {
    player = player === 'X' ? 'O' : 'X';
    aiMove();
    player = player === 'X' ? 'O' : 'X';
  } else {
    player = player === 'X' ? 'O' : 'X';
  }
}

// AI Move
function aiMove() {
  let empty = boardState.map((v,i)=>v===''?i:null).filter(v=>v!==null);
  let move;
  if(aiMode==='easy') {
    move = empty[Math.floor(Math.random()*empty.length)];
  } else if(aiMode==='medium') {
    // Win/block logic
    move = findWinningMove('O') || findWinningMove('X') || empty[Math.floor(Math.random()*empty.length)];
  } else {
    move = findBestMove(boardState, 'O');
  }
  boardState[move] = 'O';
  drawBoard();
  if(checkWin('O')) showPopup('O Wins!');
}

// Simple AI functions
function findWinningMove(p) {
  for(let i=0;i<9;i++) {
    if(boardState[i]==='') {
      boardState[i]=p;
      if(checkWin(p)) { boardState[i]=''; return i;}
      boardState[i]='';
    }
  }
  return null;
}

// Minimax for Hard
function findBestMove(bd, ai) {
  let bestScore=-Infinity;
  let move;
  for(let i=0;i<9;i++) {
    if(bd[i]==='') {
      bd[i]=ai;
      let score=minimax(bd,false);
      bd[i]='';
      if(score>bestScore){bestScore=score; move=i;}
    }
  }
  return move;
}

function minimax(bd,isMax){
  if(checkWin('O')) return 1;
  if(checkWin('X')) return -1;
  if(bd.every(c=>c!=='')) return 0;
  let scores = [];
  for(let i=0;i<9;i++){
    if(bd[i]===''){
      bd[i]=isMax?'O':'X';
      scores.push(minimax(bd,!isMax));
      bd[i]='';
    }
  }
  return isMax?Math.max(...scores):Math.min(...scores);
}

// Check win
function checkWin(p) {
  const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  return wins.some(line=>line.every(i=>boardState[i]===p));
}

// Popup
function showPopup(msg){popupText.textContent=msg; popupEl.style.display='block';}
function closePopup(){popupEl.style.display='none'; boardState=Array(9).fill(''); drawBoard(); isMyTurn=true; player='X';}

// Menu navigation
function startGame(mode){
  menuEl.style.display='none';
  gameEl.style.display='flex';
  boardState = Array(9).fill('');
  drawBoard();
  aiMode = (mode==='easy'||mode==='medium'||mode==='hard')?mode:null;
  if(mode==='online') initOnlineGame();
}
function goHome(){menuEl.style.display='block'; gameEl.style.display='none'; popupEl.style.display='none';}

// Firebase Online
function initOnlineGame(){
  onlineGameId = 'game1'; // For testing only
  const gameRef = ref(db, 'ticTacToe/'+onlineGameId+'/board');
  onValue(gameRef, (snapshot)=>{
    const data = snapshot.val();
    if(data){
      boardState = data.board;
      isMyTurn = data.turn === player;
      drawBoard();
    }
  });
  syncBoard();
}

function syncBoard(){
  if(!onlineGameId) return;
  const gameRef = ref(db, 'ticTacToe/'+onlineGameId+'/board');
  set(gameRef, { board: boardState, turn: player==='X'?'O':'X' });
}
</script>

</body>
</html>
